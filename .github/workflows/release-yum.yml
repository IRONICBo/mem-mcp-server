name: Release to YUM Repository

on:
  workflow_run:
    workflows: ["Build Binary Releases"]
    types: [completed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.0.1-test)'
        required: true

env:
  PAGES_BRANCH: gh-pages

jobs:
  build-rpm:
    name: Build RPM package
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install dependencies
        run: |
          dnf install -y rpm-build createrepo_c curl tar gzip gh

      - name: Check workflow run status
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "Build workflow failed, skipping release"
            exit 1
          fi

      - name: Get version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Get latest release version
            VERSION=$(gh release list --repo "${{ github.repository }}" --limit 1 --json tagName -q '.[0].tagName')
            VERSION="${VERSION#v}"
          fi
          # RPM version cannot contain hyphens
          RPM_VERSION=$(echo "$VERSION" | tr '-' '.')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rpm_version=$RPM_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, RPM Version: $RPM_VERSION"

      - name: Download release binary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"
          ASSET_NAME="mem-linux-x86_64.tar.gz"

          echo "Downloading ${ASSET_NAME} from release v${VERSION}..."
          gh release download "v${VERSION}" --repo "${REPO}" --pattern "${ASSET_NAME}"

          ls -la "${ASSET_NAME}"
          file "${ASSET_NAME}"

          # Extract tarball - onedir format extracts to mem/ directory
          tar -xzf "${ASSET_NAME}"
          ls -la mem/
          chmod +x mem/mem

      - name: Build RPM package
        run: |
          VERSION="${{ steps.version.outputs.rpm_version }}"
          PKG_NAME="mem"
          ARCH="x86_64"

          mkdir -p ~/rpmbuild/{SPECS,SOURCES,BUILD,RPMS,SRPMS}
          # Copy entire onedir package
          cp -r mem ~/rpmbuild/SOURCES/

          cat > ~/rpmbuild/SPECS/${PKG_NAME}.spec << EOF
          Name:           ${PKG_NAME}
          Version:        ${VERSION}
          Release:        1%{?dist}
          Summary:        AI-powered version control tool
          License:        MIT
          URL:            https://github.com/${{ github.repository }}

          %description
          Memory layer for AI coding agents

          %install
          mkdir -p %{buildroot}/usr/lib/mem
          mkdir -p %{buildroot}/usr/bin
          # Install entire onedir package
          cp -r %{_sourcedir}/mem/* %{buildroot}/usr/lib/mem/
          chmod 755 %{buildroot}/usr/lib/mem/mem
          # Create symlink
          ln -sf /usr/lib/mem/mem %{buildroot}/usr/bin/mem

          %files
          /usr/lib/mem
          /usr/bin/mem
          EOF

          rpmbuild -bb ~/rpmbuild/SPECS/${PKG_NAME}.spec
          cp ~/rpmbuild/RPMS/${ARCH}/*.rpm .

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-x86_64
          path: "*.rpm"
          retention-days: 7

  publish-yum-repo:
    name: Publish YUM Repository
    needs: build-rpm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install createrepo
        run: sudo apt-get update && sudo apt-get install -y createrepo-c

      - name: Download RPM artifact
        uses: actions/download-artifact@v4
        with:
          name: rpm-x86_64
          path: rpms/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PAGES_BRANCH }}
          path: gh-pages
        continue-on-error: true

      - name: Initialize gh-pages if not exists
        run: |
          if [ ! -d "gh-pages/.git" ]; then
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b ${{ env.PAGES_BRANCH }}
          fi

      - name: Setup YUM repository structure
        run: |
          mkdir -p gh-pages/yum/packages
          cp rpms/*.rpm gh-pages/yum/packages/

      - name: Generate YUM repository metadata
        run: |
          cd gh-pages/yum
          createrepo_c .

      - name: Create repo config file
        run: |
          PAGES_URL="${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          cat > gh-pages/yum/mem.repo << EOF
          [mem]
          name=MEM Repository
          baseurl=https://${PAGES_URL}/yum
          enabled=1
          gpgcheck=0
          EOF

      - name: Commit and push
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update YUM repository"
            git push origin ${{ env.PAGES_BRANCH }} --force
          fi
