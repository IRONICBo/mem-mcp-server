name: Build Binary Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.0.1)'
        required: true
        default: 'v0.0.1'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            artifact_name: mem
            asset_name: mem-linux-x86_64
          - os: macos-15
            platform: macos
            arch: x86_64
            artifact_name: mem
            asset_name: mem-macos-x86_64
            target_arch: x86_64
          - os: macos-latest
            platform: macos
            arch: arm64
            artifact_name: mem
            asset_name: mem-macos-arm64
          - os: windows-latest
            platform: windows
            arch: x86_64
            artifact_name: mem.exe
            asset_name: mem-windows-x86_64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv pip install --system pyinstaller
          uv pip install --system .

      - name: Build binary with PyInstaller (Linux/macOS ARM64)
        if: matrix.platform != 'windows' && matrix.target_arch != 'x86_64'
        run: |
          # Use onedir mode for faster startup (especially on macOS)
          # onefile mode is ~5-10x slower due to extraction overhead
          if [ -f "mem.spec" ]; then
            ONEFILE=0 pyinstaller mem.spec --noconfirm
          else
            pyinstaller --onedir \
              --name mem \
              --strip \
              --hidden-import=memov.core \
              --hidden-import=memov.core.manager \
              --hidden-import=memov.core.git \
              --hidden-import=memov.utils \
              --hidden-import=memov.storage \
              --hidden-import=typer \
              --hidden-import=click \
              --hidden-import=rich \
              --hidden-import=pathspec \
              --exclude-module pytest \
              --exclude-module unittest \
              --exclude-module IPython \
              --exclude-module matplotlib \
              --exclude-module chromadb \
              --exclude-module litellm \
              --noconfirm \
              memov/main.py
          fi

      - name: Build binary with PyInstaller (macOS x86_64 cross-compile)
        if: matrix.platform == 'macos' && matrix.target_arch == 'x86_64'
        run: |
          # Install x86_64 Python via Rosetta 2
          arch -x86_64 /bin/bash -c "
            curl -LsSf https://astral.sh/uv/install.sh | sh
            source \$HOME/.local/bin/env
            uv python install 3.12
            uv pip install --system pyinstaller
            uv pip install --system .
            # Use onedir mode for faster startup
            pyinstaller --onedir \
              --name mem \
              --strip \
              --hidden-import=memov.core \
              --hidden-import=memov.core.manager \
              --hidden-import=memov.core.git \
              --hidden-import=memov.utils \
              --hidden-import=memov.storage \
              --hidden-import=typer \
              --hidden-import=click \
              --hidden-import=rich \
              --hidden-import=pathspec \
              --exclude-module pytest \
              --exclude-module unittest \
              --exclude-module chromadb \
              --exclude-module litellm \
              --noconfirm \
              memov/main.py
          "

      - name: Build binary with PyInstaller (Windows)
        if: matrix.platform == 'windows'
        run: |
          # Use onedir mode for faster startup
          pyinstaller --onedir `
            --name mem `
            --hidden-import=memov.core `
            --hidden-import=memov.core.manager `
            --hidden-import=memov.core.git `
            --hidden-import=memov.utils `
            --hidden-import=memov.storage `
            --hidden-import=typer `
            --hidden-import=click `
            --hidden-import=rich `
            --hidden-import=pathspec `
            --exclude-module pytest `
            --exclude-module unittest `
            --exclude-module chromadb `
            --exclude-module litellm `
            --noconfirm `
            memov/main.py

      - name: Test binary (Linux/macOS native)
        if: matrix.platform != 'windows' && matrix.target_arch != 'x86_64'
        run: |
          # onedir mode creates dist/mem/mem
          chmod +x dist/mem/mem
          dist/mem/mem --help
          dist/mem/mem version || true

      - name: Test binary (macOS x86_64 via Rosetta)
        if: matrix.platform == 'macos' && matrix.target_arch == 'x86_64'
        run: |
          chmod +x dist/mem/mem
          arch -x86_64 dist/mem/mem --help

      - name: Test binary (Windows)
        if: matrix.platform == 'windows'
        run: |
          dist\mem\mem.exe --help

      - name: Upload artifact (directory)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/mem/
          retention-days: 7

      - name: Create tarball (Linux/macOS)
        if: matrix.platform != 'windows' && startsWith(github.ref, 'refs/tags/')
        run: |
          cd dist
          # Package as mem/ directory inside tarball
          tar -czf ${{ matrix.asset_name }}.tar.gz mem

      - name: Create zip (Windows)
        if: matrix.platform == 'windows' && startsWith(github.ref, 'refs/tags/')
        run: |
          cd dist
          Compress-Archive -Path mem -DestinationPath ${{ matrix.asset_name }}.zip

      - name: Upload Release Asset (Linux/macOS)
        if: matrix.platform != 'windows' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.asset_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset (Windows)
        if: matrix.platform == 'windows' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.asset_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-summary:
    name: Create Release Summary
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Create Release Notes
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Binary Downloads

            Download the appropriate binary for your platform:

            ### Linux
            - [mem-linux-x86_64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mem-linux-x86_64.tar.gz)

            ### macOS
            - [mem-macos-x86_64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mem-macos-x86_64.tar.gz) (Intel)
            - [mem-macos-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mem-macos-arm64.tar.gz) (Apple Silicon)

            ### Windows
            - [mem-windows-x86_64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mem-windows-x86_64.zip)

            ## Quick Install (Recommended)

            ```bash
            curl -fsSL https://raw.githubusercontent.com/memovai/memov/main/install.sh | bash
            ```

            ## Manual Installation

            ### Linux / macOS
            ```bash
            # Download and extract
            tar -xzf mem-<platform>-<arch>.tar.gz

            # Install to /usr/local/lib and create symlink
            sudo cp -r mem /usr/local/lib/
            sudo ln -sf /usr/local/lib/mem/mem /usr/local/bin/mem

            # Verify installation
            mem --help
            ```

            ### Windows
            ```powershell
            # Extract the zip file
            # Add the extracted 'mem' folder to your PATH
            # Or move mem\mem.exe to a directory in your PATH

            # Verify installation
            mem --help
            ```

            ## Performance

            This release uses **onedir** mode for fast startup:
            - First run: ~10-20s (OS security scan)
            - Subsequent runs: **~0.2s**

            See [docs/BUILD_AND_INSTALL.md](https://github.com/${{ github.repository }}/blob/main/docs/BUILD_AND_INSTALL.md) for detailed instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
